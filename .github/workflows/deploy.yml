name: Build and Deploy Site
on:
  push:
    branches: [ main ]

permissions:
  contents: write   # allow pushing to gh-pages

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - run: npm install jsdom

      # Run your builder
      - run: node website/builder.js

      # Copy static assets into the output folder
      - name: Copy static files
        run: |
          mkdir -p out
          cp website/main.css out/
          cp website/main.js out/
          cp website/favicon.ico out/
          cp -r website/icon out/icon

      # Copy all PDFs from main branch
      - name: Copy PDFs from main branch
        run: |
          git fetch origin main
          mkdir -p out/pdf
          # List all PDFs in the main branch and copy them
          git ls-tree -r origin/main --name-only | grep '\.pdf$' | while read file; do
            mkdir -p "out/pdf/$(dirname "$file")"
            git show origin/main:"$file" > "out/pdf/$file"
          done

      # Deploy to gh-pages
      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./out
